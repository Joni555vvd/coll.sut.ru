import React, { useMemo, useState } from "react";

/**
 * MVP —Ç—Ä–µ–Ω–∞–∂—ë—Ä –º—ã—à–ª–µ–Ω–∏—è ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä—è–º–æ –∑–¥–µ—Å—å.
 * –í–ê–ñ–ù–û: –±–µ–∑ shadcn/alias –∏–º–ø–æ—Ä—Ç–æ–≤ ("@/...") ‚Äî —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ —Ä–∞–±–æ—Ç–∞–ª–æ –≤ –ø—Ä–µ–≤—å—é —á–∞—Ç–∞.
 *
 * –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏:
 * - 5 –∑–∞–¥–∞—á, —É –∫–∞–∂–¥–æ–π –ø–æ–¥–ø–∏—Å–∞–Ω —Ç—Ä–µ–Ω–∏—Ä—É–µ–º—ã–π –Ω–∞–≤—ã–∫
 * - –î–∏–∞–ª–æ–≥ ¬´–∫–æ—É—á–∞¬ª (–Ω–µ –¥–∞—ë—Ç –æ—Ç–≤–µ—Ç–æ–≤), —Å—Ç–æ–ø—ã –∑–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
 * - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Ä–µ—Ñ–ª–µ–∫—Å–∏—è
 * - –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç (–±–µ–∑ –≤—ã–±–æ—Ä–∞)
 */

type Task = {
  id: number;
  title: string;
  skill: string;
  prompt: string;
};

type Msg = { role: "user" | "coach"; text: string };

// --- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä ¬´–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á¬ª –Ω–∞ –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π —Ü–∏–∫–ª ---
// –ò–¥–µ—è: –º—ã —Ö—Ä–∞–Ω–∏–º –ù–ï –≥–æ—Ç–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è, –∞ —à–∞–±–ª–æ–Ω—ã (templates) + –Ω–∞–±–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤.
// –ü—Ä–∏ –∫–∞–∂–¥–æ–º ¬´–ù–æ–≤—ã–π —Ü–∏–∫–ª¬ª –∑–∞–¥–∞—á–∏ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é—Ç—Å—è —Å –Ω–æ–≤—ã–º–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞–º–∏.

type TaskTemplate = {
  id: number;
  skill: string;
  title: string;
  makePrompt: (ctx: string) => string;
};

const CONTEXTS = [
  "–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
  "–ø–æ–∫—É–ø–∫–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ",
  "—Å–æ–≤–µ—Ç –∏–∑ —Å–æ—Ü—Å–µ—Ç–µ–π",
  "–≤—ã–±–æ—Ä –ø–æ–¥—Ä—è–¥—á–∏–∫–∞",
  "–æ–±—É—á–∞—é—â–∏–π –∫—É—Ä—Å",
  "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (–Ω–µ –ª–µ—á–∏–º, –∞ –æ—Ü–µ–Ω–∏–≤–∞–µ–º –¥–æ–≤–æ–¥—ã)",
  "—Ä–µ—à–µ–Ω–∏–µ –≤ –∫–æ–º–∞–Ω–¥–µ",
  "—Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞",
  "–Ω–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞",
  "–≤–Ω–µ–∑–∞–ø–Ω—ã–π —Å–ø–∞–¥ –º–µ—Ç—Ä–∏–∫–∏",
];

const VARIANTS = {
  obvious: [
    "–û—á–µ–≤–∏–¥–Ω–æ, —á—Ç–æ —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ",
    "–≠—Ç–æ —Ç–æ—á–Ω–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —Ç—É—Ç –∏ –¥—É–º–∞—Ç—å –Ω–µ—á–µ–≥–æ",
    "–î–∞ —Ç—É—Ç –≤—Å—ë –ø–æ–Ω—è—Ç–Ω–æ: —Ä–∏—Å–∫–∞ –Ω–µ—Ç",
  ],
  always: [
    "–Ø —É–≤–µ—Ä–µ–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ –≤—Å–µ–≥–¥–∞ —Ç–∞–∫ —Ä–∞–±–æ—Ç–∞–ª–æ",
    "–†–∞–Ω—å—à–µ –±—ã–ª–æ —Ç–∞–∫ ‚Äî –∑–Ω–∞—á–∏—Ç –∏ —Å–µ–π—á–∞—Å –±—É–¥–µ—Ç —Ç–∞–∫",
    "–ú—ã 10 —Ä–∞–∑ —Ç–∞–∫ –¥–µ–ª–∞–ª–∏, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±",
  ],
  cause: [
    "–ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç A, –≤—Å–∫–æ—Ä–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç B",
    "–ü–æ—Å–ª–µ A –æ–±—ã—á–Ω–æ —Å–ª—É—á–∞–µ—Ç—Å—è B",
    "A –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É–µ—Ç B",
  ],
  vuca: [
    "–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ –∏ –Ω–µ–ø–æ–ª–Ω—ã–µ",
    "—Å–∏–≥–Ω–∞–ª—ã –µ—Å—Ç—å, –Ω–æ –¥–æ–≤–µ—Ä–∏–µ –∫ –Ω–∏–º —Ä–∞–∑–Ω–æ–µ",
    "—Å—Ç–æ–∏–º–æ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤—ã—Å–æ–∫–∞—è, –Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –º–∞–ª–æ",
  ],
  system: [
    "–¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è/–ø—Ä–æ–≤–µ—Ä–æ–∫",
    "—É—Å–∏–ª–∏—Ç—å —Ä–µ–≥–ª–∞–º–µ–Ω—Ç",
    "–≤–≤–µ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è",
  ],
};

function pick<T>(arr: T[], rng: () => number) {
  return arr[Math.floor(rng() * arr.length)];
}

function shuffle<T>(arr: T[], rng: () => number) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function makeRng(seed: number) {
  // –ø—Ä–æ—Å—Ç–æ–π LCG (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä)
  let s = seed >>> 0;
  return () => {
    s = (1664525 * s + 1013904223) >>> 0;
    return s / 4294967296;
  };
}

const TEMPLATES: TaskTemplate[] = [
  {
    id: 1,
    skill: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ ¬∑ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è",
    title: "–ó–∞–¥–∞—á–∞ ‚Ññ1 ‚Äî ¬´–û—á–µ–≤–∏–¥–Ω–æ?¬ª",
    makePrompt: (ctx) => {
      return `–î–≤–∞ —á–µ–ª–æ–≤–µ–∫–∞ –æ–±—Å—É–∂–¥–∞—é—Ç ${ctx}. –û–¥–∏–Ω –≥–æ–≤–æ—Ä–∏—Ç: ¬´${pick(VARIANTS.obvious, Math.random)}¬ª.

–ú–æ–∂–Ω–æ –ª–∏ —Å—á–∏—Ç–∞—Ç—å —ç—Ç–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º?

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: –Ω–∞–∑–æ–≤–∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ ¬´–±–µ–∑–æ–ø–∞—Å–Ω–æ/–Ω–æ—Ä–º–∞–ª—å–Ω–æ¬ª –∏ —á—Ç–æ –º–æ–≥–ª–æ –±—ã —ç—Ç–æ –æ–ø—Ä–æ–≤–µ—Ä–≥–Ω—É—Ç—å.`;
    },
  },
  {
    id: 2,
    skill: "–õ–æ–≥–∏–∫–∞ ¬∑ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ",
    title: "–ó–∞–¥–∞—á–∞ ‚Ññ2 ‚Äî ¬´–£–≤–µ—Ä–µ–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—Å–µ–≥–¥–∞¬ª",
    makePrompt: (ctx) => {
      return `–í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ ${ctx} —á–µ–ª–æ–≤–µ–∫ –≥–æ–≤–æ—Ä–∏—Ç: ¬´${pick(VARIANTS.always, Math.random)}¬ª.

–ú–æ–∂–Ω–æ –ª–∏ –ø—Ä–∏–Ω—è—Ç—å —Ç–∞–∫–æ–π –≤—ã–≤–æ–¥ –±–µ–∑ —Ä–∞–∑–±–æ—Ä–∞?

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: —É–∫–∞–∂–∏, –∫–∞–∫–∏–µ —É—Å–ª–æ–≤–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–∏–∑–º–µ–Ω–Ω—ã, –∏ –ø—Ä–∏–¥—É–º–∞–π –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.`;
    },
  },
  {
    id: 3,
    skill: "–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–∏–ø–æ—Ç–µ–∑",
    title: "–ó–∞–¥–∞—á–∞ ‚Ññ3 ‚Äî ¬´–ú–∏–Ω–∏-—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç¬ª",
    makePrompt: (ctx) => {
      return `–¢—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è ${ctx} –∏ –∑–∞—è–≤–ª—è–µ—à—å: ¬´–≠—Ç–æ –ø–æ–≤—ã—Å–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç¬ª.

–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –ø—Ä–æ–≤–µ—Ä—è–µ–º—É—é –≥–∏–ø–æ—Ç–µ–∑—É + –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∞–∫, —á—Ç–æ–±—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–≥ –æ–ø—Ä–æ–≤–µ—Ä–≥–Ω—É—Ç—å –∏–¥–µ—é.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: –º–µ—Ç—Ä–∏–∫–∞, –æ–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç, —É—Å–ª–æ–≤–∏–µ –ø—Ä–æ–≤–∞–ª–∞, –¥–∏–∑–∞–π–Ω —Ç–µ—Å—Ç–∞.`;
    },
  },
  {
    id: 4,
    skill: "–†–∞–±–æ—Ç–∞ —Å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å—é (VUCA) ¬∑ –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π",
    title: "–ó–∞–¥–∞—á–∞ ‚Ññ4 ‚Äî ¬´–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö¬ª",
    makePrompt: (ctx) => {
      return `–¢–µ–±–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –ø–æ ${ctx} —Å–µ–≥–æ–¥–Ω—è. –ü—Ä–∏ —ç—Ç–æ–º ${pick(VARIANTS.vuca, Math.random)}.

–ß—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å –¥–∞–ª—å—à–µ: (–∞) –¥–µ–π—Å—Ç–≤—É–µ—à—å —Å–µ–π—á–∞—Å, (–±) –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—à—å, (–≤) –¥–µ–ª–∞–µ—à—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —à–∞–≥?

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: –∫—Ä–∏—Ç–µ—Ä–∏–∏ —Ä–µ—à–µ–Ω–∏—è + —Å–Ω–∏–∂–µ–Ω–∏–µ —Ä–∏—Å–∫–∞.`;
    },
  },
  {
    id: 5,
    skill: "–°–∏—Å—Ç–µ–º–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ ¬∑ –†–µ—à–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á ¬∑ –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ",
    title: "–ó–∞–¥–∞—á–∞ ‚Ññ5 ‚Äî ¬´–õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–∞–≤–∫–∞, –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è¬ª",
    makePrompt: (ctx) => {
      return `–í —Å–∏—Å—Ç–µ–º–µ –≤–æ–∫—Ä—É–≥ ${ctx} –ø–∞–¥–∞–µ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å ¬´–∫–∞—á–µ—Å—Ç–≤–æ¬ª. –ü—Ä–µ–¥–ª–∞–≥–∞—é—Ç –ø—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ: ¬´${pick(VARIANTS.system, Math.random)} ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ –≤—ã—Ä–∞—Å—Ç–µ—Ç¬ª.

–ö–∞–∫–∏–µ 3‚Äì4 –≤—Ç–æ—Ä–∏—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–∞ —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç?

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: 3‚Äì4 —Ü–µ–ø–æ—á–∫–∏ –ø—Ä–∏—á–∏–Ω‚Äì—Å–ª–µ–¥—Å—Ç–≤–∏–π (A‚ÜíB‚ÜíC) –∏ –≥–¥–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–∞–¥–µ—Ä–∂–∫–∞/–æ–±—Ö–æ–¥.`;
    },
  },
];

function generateTasks(seed: number): Task[] {
  const rng = makeRng(seed);

  // –®–∞–±–ª–æ–Ω—ã –Ω–∞–≤—ã–∫–æ–≤ (–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã)
  const templates = [
    {
      key: "replace-fillers",
      skill: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ ¬∑ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è",
      title: "¬´–£–±–µ—Ä–∏ –∑–∞–º–µ–Ω–∏—Ç–µ–ª–∏ ‚Äî —Å–¥–µ–ª–∞–π –º—ã—Å–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ–º–æ–π¬ª",
      make: (_ctx: string) => {
        return `# üß† –ó–∞–¥–∞—á–∞: ¬´–£–±–µ—Ä–∏ –∑–∞–º–µ–Ω–∏—Ç–µ–ª–∏ ‚Äî —Å–¥–µ–ª–∞–π –º—ã—Å–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ–º–æ–π¬ª

## üéØ –¶–µ–ª—å
–ó–∞–º–µ–Ω–∏—Ç—å —Å–ª–æ–≤–∞ —Ç–∏–ø–∞ ¬´–æ—á–µ–≤–∏–¥–Ω–æ/–ø–æ–Ω—è—Ç–Ω–æ/–ø—Ä–æ—Å—Ç–æ¬ª –Ω–∞ **—É—Å–ª–æ–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏**: —á—Ç–æ –Ω—É–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å/–∏–∑–º–µ—Ä–∏—Ç—å/—Å—Ä–∞–≤–Ω–∏—Ç—å, —á—Ç–æ–±—ã —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è –∏–ª–∏ –æ–ø—Ä–æ–≤–µ—Ä–≥–Ω—É—Ç—å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.

---

## üì• –í—Ö–æ–¥
–ù–∞–ø–∏—à–∏ **1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è** —Å —Ç–≤–æ–∏–º —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º, –≥–¥–µ –µ—Å—Ç—å —Å–ª–æ–≤–∞-–∑–∞–º–µ–Ω–∏—Ç–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–æ—á–µ–≤–∏–¥–Ω–æ¬ª, ¬´–ø–æ–Ω—è—Ç–Ω–æ¬ª, ¬´–ø—Ä–æ—Å—Ç–æ¬ª, ¬´–≤—Å–µ–º —è—Å–Ω–æ¬ª, ¬´–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ¬ª).

---

## ‚úÖ –¢–≤–æ—è –∑–∞–¥–∞—á–∞
–°–¥–µ–ª–∞–π **–û–î–ù–£** –ø—Ä–∞–≤–∫—É:
- —É–±–µ—Ä–∏ —Å–ª–æ–≤–∞-–∑–∞–º–µ–Ω–∏—Ç–µ–ª–∏;
- –¥–æ–±–∞–≤—å **—É—Å–ª–æ–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏**.

### –ü—Ä–∞–≤–∏–ª–æ
- **–ù–µ –æ–±—ä—è—Å–Ω—è–π –ø—Ä–∏—á–∏–Ω—É.**
- **–î–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É.**

---

## üß© –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–≤—ã–±–µ—Ä–∏ 1 —à–∞–±–ª–æ–Ω)
–í—ã–±–µ—Ä–∏ **–æ–¥–∏–Ω** –∏ –∑–∞–ø–æ–ª–Ω–∏:

1) **–ï—Å–ª–∏ / —Ç–æ**
- ¬´X –≤–µ—Ä–Ω–æ, **–µ—Å–ª–∏** ‚Ä¶¬ª

2) **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ–º**
- ¬´–≠—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, **–ø–æ—Å–º–æ—Ç—Ä–µ–≤ –Ω–∞** ‚Ä¶¬ª

3) **–ü–æ—Ä–æ–≥ / –∫—Ä–∏—Ç–µ—Ä–∏–π**
- ¬´–°—á–∏—Ç–∞–µ–º X –≤–µ—Ä–Ω—ã–º, **–∫–æ–≥–¥–∞** ‚Ä¶ (–∫—Ä–∏—Ç–µ—Ä–∏–π/–ø–æ—Ä–æ–≥)¬ª

4) **–¢–µ—Å—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º**
- ¬´–ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å ___, —Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç–∞–Ω–µ—Ç ___¬ª

---

## üìå –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –±–µ–∑ —Å–ª–æ–≤-–∑–∞–º–µ–Ω–∏—Ç–µ–ª–µ–π
- –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã **–¥—Ä—É–≥–æ–π —á–µ–ª–æ–≤–µ–∫ –ø–æ–Ω—è–ª, —á—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å**

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π –ø—Ä–∏–Ω—è—Ç–∏—è
–û—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç, –µ—Å–ª–∏:
- –Ω–µ—Ç —Å–ª–æ–≤-–∑–∞–º–µ–Ω–∏—Ç–µ–ª–µ–π;
- –µ—Å—Ç—å **–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏** (—á—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å / —á—Ç–æ –∏–∑–º–µ—Ä–∏—Ç—å / —Å —á–µ–º —Å—Ä–∞–≤–Ω–∏—Ç—å / –∫–∞–∫–æ–π –ø–æ—Ä–æ–≥).

---

## üîÅ –ï—Å–ª–∏ —Å–Ω–æ–≤–∞ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å (–∞–Ω—Ç–∏-—Ñ—Ä—É—Å—Ç—Ä–∞—Ü–∏—è)
–ù–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–π –≤—Å—ë.

1) –≤–æ–∑—å–º–∏ **–æ–¥–Ω–æ** –ø—Ä–æ–±–ª–µ–º–Ω–æ–µ —Å–ª–æ–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–æ—á–µ–≤–∏–¥–Ω–æ¬ª);
2) –¥–æ–ø–∏—à–∏ **–æ–¥–Ω–æ** –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –Ω–∞—á–∏–Ω–∞—é—â–µ–µ—Å—è —Å:

**¬´–≠—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å–ª–∏ ‚Ä¶¬ª**

---

## üü¢ –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ (–µ—Å–ª–∏ –∑–∞—Å—Ç—Ä—è–ª)
–ú–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π:
- ¬´–ü–æ–∫–∞–∑–∞—Ç—å 2 –ø—Ä–∏–º–µ—Ä–∞¬ª
- ¬´–î–∞–π –º–Ω–µ 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–ª—è –º–æ–µ–π —Ñ—Ä–∞–∑—ã¬ª
- ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª

---

## üëá –ü—Ä–∏–º–µ—Ä—ã (2 —à—Ç—É–∫–∏)

**–ë—ã–ª–æ:** ¬´–û—á–µ–≤–∏–¥–Ω–æ, —á—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ.¬ª
**–°—Ç–∞–ª–æ:** ¬´–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–∏—Ç–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º, **–µ—Å–ª–∏** –ø–æ—Å–ª–µ —Ä–µ–ª–∏–∑–∞ –¥–æ–ª—è –æ—à–∏–±–æ–∫ –Ω–µ –≤—ã—Ä–∞—Å—Ç–µ—Ç –≤—ã—à–µ 0.5% –∏ –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∂–∞–ª–æ–± –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.¬ª

**–ë—ã–ª–æ:** ¬´–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –≤—ã–≥–æ–¥–Ω–µ–µ.¬ª
**–°—Ç–∞–ª–æ:** ¬´–í–∞—Ä–∏–∞–Ω—Ç –≤—ã–≥–æ–¥–Ω–µ–µ, **–µ—Å–ª–∏** –ø—Ä–∏ —Ç–µ—Ö –∂–µ —É—Å–ª–æ–≤–∏—è—Ö –æ–Ω –¥–∞—ë—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∏–∂–µ –Ω–∞ ‚â•10% (—Å —É—á—ë—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏ –∏ –¥–æ—Å—Ç–∞–≤–∫–∏).¬ª`;
      },
    },
    {
      key: "always",
      skill: "–õ–æ–≥–∏–∫–∞ ¬∑ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ",
      title: "¬´–ü–æ—Ç–æ–º—É —á—Ç–æ –≤—Å–µ–≥–¥–∞¬ª",
      make: (ctx: string) => {
        const phrase = pick(VARIANTS.always, rng);
        return `–í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ ${ctx} —á–µ–ª–æ–≤–µ–∫ –≥–æ–≤–æ—Ä–∏—Ç: ¬´${phrase}¬ª.

–ú–æ–∂–Ω–æ –ª–∏ –ø—Ä–∏–Ω—è—Ç—å —Ç–∞–∫–æ–π –≤—ã–≤–æ–¥ –±–µ–∑ —Ä–∞–∑–±–æ—Ä–∞?

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: (1) –∫–∞–∫–∏–µ —É—Å–ª–æ–≤–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–∏–∑–º–µ–Ω–Ω—ã; (2) –ø—Ä–∏–¥—É–º–∞–π –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏ –∫–∞–∫ –±—ã —Ç—ã –µ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏–ª.`;
      },
    },
    {
      skill: "–õ–æ–≥–∏–∫–∞ ¬∑ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ",
      title: "¬´–ü–æ—Ç–æ–º—É —á—Ç–æ –≤—Å–µ–≥–¥–∞¬ª",
      make: (ctx: string) => {
        const phrase = pick(VARIANTS.always, rng);
        return `–í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ ${ctx} —á–µ–ª–æ–≤–µ–∫ –≥–æ–≤–æ—Ä–∏—Ç: ¬´${phrase}¬ª.

–ú–æ–∂–Ω–æ –ª–∏ –ø—Ä–∏–Ω—è—Ç—å —Ç–∞–∫–æ–π –≤—ã–≤–æ–¥ –±–µ–∑ —Ä–∞–∑–±–æ—Ä–∞?

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: (1) –∫–∞–∫–∏–µ —É—Å–ª–æ–≤–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–∏–∑–º–µ–Ω–Ω—ã; (2) –ø—Ä–∏–¥—É–º–∞–π –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏ –∫–∞–∫ –±—ã —Ç—ã –µ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏–ª.`;
      },
    },
    {
      key: "hypothesis",
      skill: "–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–∏–ø–æ—Ç–µ–∑",
      title: "¬´–ú–∏–Ω–∏-—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç¬ª",
      make: (ctx: string) => {
        return `–¢—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è ${ctx} –∏ –∑–∞—è–≤–ª—è–µ—à—å: ¬´–≠—Ç–æ –ø–æ–≤—ã—Å–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç¬ª.

–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –ø—Ä–æ–≤–µ—Ä—è–µ–º—É—é –≥–∏–ø–æ—Ç–µ–∑—É + –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∞–∫, —á—Ç–æ–±—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–≥ –æ–ø—Ä–æ–≤–µ—Ä–≥–Ω—É—Ç—å –∏–¥–µ—é.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: –º–µ—Ç—Ä–∏–∫–∞, –æ–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç, —É—Å–ª–æ–≤–∏–µ –ø—Ä–æ–≤–∞–ª–∞, –¥–∏–∑–∞–π–Ω —Ç–µ—Å—Ç–∞.`;
      },
    },
    {
      key: "vuca",
      skill: "–†–∞–±–æ—Ç–∞ —Å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å—é (VUCA) ¬∑ –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π",
      title: "¬´–ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ¬ª",
      make: (ctx: string) => {
        const phrase = pick(VARIANTS.vuca, rng);
        return `–¢–µ–±–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –ø–æ ${ctx} —Å–µ–≥–æ–¥–Ω—è. –ü—Ä–∏ —ç—Ç–æ–º ${phrase}.

–ß—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å –¥–∞–ª—å—à–µ: (–∞) –¥–µ–π—Å—Ç–≤—É–µ—à—å —Å–µ–π—á–∞—Å, (–±) –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—à—å, (–≤) –¥–µ–ª–∞–µ—à—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —à–∞–≥?

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: –∫—Ä–∏—Ç–µ—Ä–∏–∏ —Ä–µ—à–µ–Ω–∏—è + –∫–∞–∫ —Ç—ã —Å–Ω–∏–∂–∞–µ—à—å —Ä–∏—Å–∫ –æ—à–∏–±–∫–∏.`;
      },
    },
    {
      key: "system",
      skill: "–°–∏—Å—Ç–µ–º–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ ¬∑ –†–µ—à–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á ¬∑ –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ",
      title: "¬´–ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã¬ª",
      make: (ctx: string) => {
        const phrase = pick(VARIANTS.system, rng);
        return `–í —Å–∏—Å—Ç–µ–º–µ –≤–æ–∫—Ä—É–≥ ${ctx} –ø–∞–¥–∞–µ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å ¬´–∫–∞—á–µ—Å—Ç–≤–æ¬ª. –ü—Ä–µ–¥–ª–∞–≥–∞—é—Ç –ø—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ: ¬´${phrase} ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ –≤—ã—Ä–∞—Å—Ç–µ—Ç¬ª.

–ö–∞–∫–∏–µ 3‚Äì4 –≤—Ç–æ—Ä–∏—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–∞ —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç?

–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: 3‚Äì4 —Ü–µ–ø–æ—á–∫–∏ –ø—Ä–∏—á–∏–Ω‚Äì—Å–ª–µ–¥—Å—Ç–≤–∏–π (A‚ÜíB‚ÜíC) –∏ –≥–¥–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–∞–¥–µ—Ä–∂–∫–∞/–æ–±—Ö–æ–¥.`;
      },
    },
  ];

  // ‚ùó –û–¥–∏–Ω-–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω –∑–∞ —Ü–∏–∫–ª
  const tpl = pick(templates, rng);
  const ctx = pick(CONTEXTS, rng);

  return [
    {
      id: 1,
      title: `–ó–∞–¥–∞—á–∞ ‚Ññ1 ‚Äî ${tpl.title}`,
      skill: tpl.skill,
      prompt: tpl.make(ctx),
    },
  ];
}

const INITIAL_SEED = 12345; // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —Å–∏–¥


function normalize(s: string) {
  return (s || "").trim();
}

function countWords(text: string) {
  const t = text.trim();
  if (!t) return 0;
  return t.split(/\s+/).length;
}

function containsAny(text: string, needles: string[]) {
  const t = text.toLowerCase();
  return needles.some((n) => t.includes(n));
}

function coachReply(userText: string, taskId: number): { reply: string; requiresMore: boolean } {
  const t = userText.trim();
  const words = countWords(t);

  // Stop-triggers (fail-state)
  const tooShort = words < 14;
  const isYesNo = /^(–¥–∞|–Ω–µ—Ç)\b/i.test(t) || (words < 6 && containsAny(t, ["–¥–∞", "–Ω–µ—Ç"]));
  const handwavy = containsAny(t, ["–æ—á–µ–≤–∏–¥–Ω–æ", "–ø–æ–Ω—è—Ç–Ω–æ", "–ø—Ä–æ—Å—Ç–æ", "–∫–∞–∫ –≤—Å–µ–≥–¥–∞", "–≤—Å–µ–º –∏–∑–≤–µ—Å—Ç–Ω–æ", "–Ω—É"]);

  if (!t) {
    return {
      reply:
        "–°—Ç–æ–ø. –ù–µ–ª—å–∑—è –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –±–µ–∑ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è. –ù–∞–ø–∏—à–∏ 2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ ‚Üí –æ—Å–Ω–æ–≤–∞–Ω–∏–µ ‚Üí –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å.",
      requiresMore: true,
    };
  }

  if (isYesNo) {
    return {
      reply: "–°—Ç–æ–ø. ¬´–î–∞/–Ω–µ—Ç¬ª –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—é. –î–∞–π –∫—Ä–∏—Ç–µ—Ä–∏–∏ (–ø–æ —á–µ–º—É —Ä–µ—à–∞–µ—à—å) –∏ –ø—Ä–æ–≤–µ—Ä–∫—É (–∫–∞–∫ –±—ã —É–±–µ–¥–∏–ª—Å—è).",
      requiresMore: true,
    };
  }

  if (tooShort) {
    return {
      reply:
        "–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ ‚Äî –ø–æ—Ö–æ–∂–µ –Ω–∞ –º–Ω–µ–Ω–∏–µ. –î–æ–±–∞–≤—å: (1) —á—Ç–æ —Ç—ã –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—à—å, (2) –ø–æ—á–µ–º—É —Ç–∞–∫ –¥—É–º–∞–µ—à—å, (3) —á—Ç–æ –º–æ–≥–ª–æ –±—ã —ç—Ç–æ –æ–ø—Ä–æ–≤–µ—Ä–≥–Ω—É—Ç—å.",
      requiresMore: true,
    };
  }

  if (handwavy) {
    return {
      reply:
        "–¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å ¬´–æ—á–µ–≤–∏–¥–Ω–æ/–ø—Ä–æ—Å—Ç–æ/–ø–æ–Ω—è—Ç–Ω–æ¬ª. –Ø –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—é —ç—Ç–æ –±–µ–∑ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è. –ü–µ—Ä–µ–ø–∏—à–∏ –±–µ–∑ —ç—Ç–∏—Ö —Å–ª–æ–≤ + –¥–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π.",
      requiresMore: true,
    };
  }

  // Task-specific coaching (questions only)
  if (taskId === 1) {
    return {
      reply:
        "–£—Ç–æ—á–Ω—è—é: 1) —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∑–Ω–∞—á–∏—Ç ¬´–±–µ–∑–æ–ø–∞—Å–Ω–æ¬ª (–¥–ª—è –∫–æ–≥–æ/–≤ –∫–∞–∫–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö)? 2) –∫–∞–∫–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –æ–ø—Ä–æ–≤–µ—Ä–≥–Ω–µ—Ç ¬´–±–µ–∑–æ–ø–∞—Å–Ω–æ¬ª? 3) —á–µ–º ¬´–∫–∞–∂–µ—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ¬ª –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç ¬´–¥–æ–∫–∞–∑–∞–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ¬ª?",
      requiresMore: false,
    };
  }
  if (taskId === 2) {
    return {
      reply:
        "–†–∞–∑–ª–æ–∂–∏ –∞—Ä–≥—É–º–µ–Ω—Ç: 1) —á—Ç–æ –∑–Ω–∞—á–∏—Ç ¬´–≤—Å–µ–≥–¥–∞¬ª (–∫–∞–∫–∏–µ —Å–ª—É—á–∞–∏)? 2) —á—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º, —á—Ç–æ–±—ã –≤—ã–≤–æ–¥ –¥–µ—Ä–∂–∞–ª—Å—è? 3) –ø—Ä–∏–¥—É–º–∞–π –æ–¥–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Å–ª–æ–º–∞–µ—Ç –≤—ã–≤–æ–¥, –∏ –∫–∞–∫ –±—ã —Ç—ã –µ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏–ª.",
      requiresMore: false,
    };
  }
  if (taskId === 3) {
    return {
      reply:
        "–°–¥–µ–ª–∞–π –≥–∏–ø–æ—Ç–µ–∑—É —Å—Ç—Ä–æ–≥–æ–π: 1) –º–µ—Ç—Ä–∏–∫–∞ (—á—Ç–æ –º–µ—Ä—è–µ–º), 2) –æ–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç (–Ω–∞ —Å–∫–æ–ª—å–∫–æ), 3) —É—Å–ª–æ–≤–∏–µ –ø—Ä–æ–≤–∞–ª–∞ (—á—Ç–æ –¥–æ–∫–∞–∂–µ—Ç, —á—Ç–æ —Ç—ã –æ—à–∏–±—Å—è), 4) –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç (A/B –∏–ª–∏ –¥–æ/–ø–æ—Å–ª–µ) –∏ –∫–∞–∫–æ–π —Ç–∞–º —Ä–∏—Å–∫ —Å–º–µ—â–µ–Ω–∏—è.",
      requiresMore: false,
    };
  }
  if (taskId === 4) {
    return {
      reply:
        "–ü—Ä–∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏: 1) –Ω–∞–∑–æ–≤–∏ 2‚Äì3 –∫—Ä–∏—Ç–µ—Ä–∏—è —Ä–µ—à–µ–Ω–∏—è (—Ä–∏—Å–∫/–≤–ª–∏—è–Ω–∏–µ/–æ–±—Ä–∞—Ç–∏–º–æ—Å—Ç—å), 2) –∫–∞–∫–æ–π –æ–¥–∏–Ω —Ñ–∞–∫—Ç –±—ã–ª –±—ã —Ä–µ—à–∞—é—â–∏–º –∏ –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –µ–≥–æ –¥–æ–±—ã—Ç—å, 3) –ø—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —à–∞–≥, –∫–æ—Ç–æ—Ä—ã–π —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ (—á–∞—Å—Ç–∏—á–Ω—ã–π –∑–∞–ø—É—Å–∫/—Ñ–∏—á–∞-—Ñ–ª–∞–≥/–∫–∞–Ω–∞—Ä–µ–µ—á–Ω—ã–π —Ä–µ–ª–∏–∑).",
      requiresMore: false,
    };
  }
  return {
    reply:
      "–°–∏—Å—Ç–µ–º–Ω–æ: –¥–∞–π 3‚Äì4 —Ü–µ–ø–æ—á–∫–∏ –ø—Ä–∏—á–∏–Ω‚Äì—Å–ª–µ–¥—Å—Ç–≤–∏–π. –î–ª—è –∫–∞–∂–¥–æ–π: (A) —á—Ç–æ –º–µ–Ω—è–µ–º ‚Üí (B) —á—å—ë –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–µ–Ω—è–µ—Ç—Å—è ‚Üí (C) –∫–∞–∫–∞—è –º–µ—Ç—Ä–∏–∫–∞ —É—Ö—É–¥—à–∏—Ç—Å—è ‚Üí (D) –≥–¥–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–∞–¥–µ—Ä–∂–∫–∞/–æ–±—Ö–æ–¥/–ø–æ–±–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç.",
    requiresMore: false,
  };
}

function reflectionValid(r: { q1: string; q2: string; q3: string }) {
  const a = normalize(r.q1);
  const b = normalize(r.q2);
  const c = normalize(r.q3);
  if (!a || !b || !c) return false;
  if (countWords(a) < 6 || countWords(b) < 6 || countWords(c) < 6) return false;
  return true;
}

function Pill({ children }: { children: React.ReactNode }) {
  return (
    <span
      style={{
        display: "inline-block",
        padding: "4px 10px",
        borderRadius: 999,
        background: "rgba(0,0,0,0.06)",
        fontSize: 12,
        lineHeight: "16px",
      }}
    >
      {children}
    </span>
  );
}

function Box({ children }: { children: React.ReactNode }) {
  return (
    <div
      style={{
        border: "1px solid rgba(0,0,0,0.12)",
        borderRadius: 14,
        padding: 16,
        background: "white",
        boxShadow: "0 1px 8px rgba(0,0,0,0.05)",
      }}
    >
      {children}
    </div>
  );
}

export default function MVPThinkingTrainer() {
  const [stage, setStage] = useState<"start" | "task" | "reflect" | "done">("start");
  const [cycle, setCycle] = useState(1);
  const [seed, setSeed] = useState(INITIAL_SEED);
  const [tasks, setTasks] = useState<Task[]>(() => generateTasks(INITIAL_SEED));
    const [taskIndex, setTaskIndex] = useState(0);
  const task = tasks[taskIndex];

  const [draft, setDraft] = useState("");
  const [messages, setMessages] = useState<Msg[]>([]);
  const [lock, setLock] = useState(false);
  const [reflection, setReflection] = useState({ q1: "", q2: "", q3: "" });

  const progressLabel = useMemo(() => {
    if (stage === "done") return "–ì–æ—Ç–æ–≤–æ";
    return `–¶–∏–∫–ª ${cycle} ¬∑ –ó–∞–¥–∞—á–∞ ${taskIndex + 1} –∏–∑ ${tasks.length}`;
  }, [stage, taskIndex]);

  function start() {
    setStage("task");
    setTaskIndex(0);
    setTasks(generateTasks(seed));
    setMessages([
      {
        role: "coach",
        text:
          "–ü—Ä–∞–≤–∏–ª–∞: —è –ù–ï –¥–∞—é –æ—Ç–≤–µ—Ç—ã. –Ø –∑–∞–¥–∞—é –≤–æ–ø—Ä–æ—Å—ã –∏ —Å—Ç–∞–≤–ª—é —Å—Ç–æ–ø, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–π.\n\n–°–Ω–∞—á–∞–ª–∞ –æ–ø–∏—à–∏, –∫–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å (2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).",
      },
    ]);
    setDraft("");
    setLock(false);
    setReflection({ q1: "", q2: "", q3: "" });
  }

  function resetAll() {
    setStage("start");
    setTaskIndex(0);
    setMessages([]);
    setDraft("");
    setLock(false);
    setReflection({ q1: "", q2: "", q3: "" });

    // –°–±—Ä–æ—Å –≤ –ø–µ—Ä–≤—ã–π —Ü–∏–∫–ª –∏ –Ω–æ–≤–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ
    setCycle(1);
    setSeed(INITIAL_SEED);
    setTasks(generateTasks(INITIAL_SEED));
  }

  function submitMessage() {
    const userText = draft;
    setDraft("");

    const userMsg: Msg = { role: "user", text: userText };
    const { reply, requiresMore } = coachReply(userText, task.id);
    const coachMsg: Msg = { role: "coach", text: reply };

    setMessages((m) => [...m, userMsg, coachMsg]);
    setLock(requiresMore);
  }

  function goToReflection() {
    if (lock) return;
    setStage("reflect");
  }

  function submitReflection() {
    if (!reflectionValid(reflection)) return;

    if (taskIndex + 1 < tasks.length) {
      const nextIndex = taskIndex + 1;
      setTaskIndex(nextIndex);
      setStage("task");
      setMessages([
        {
          role: "coach",
          text: "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞. –°–Ω–∞—á–∞–ª–∞ ‚Äî —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ (2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è). –ë–µ–∑ ¬´–¥–∞/–Ω–µ—Ç¬ª.",
        },
      ]);
      setDraft("");
      setLock(false);
      setReflection({ q1: "", q2: "", q3: "" });
    } else {
      setStage("done");
    }
  }

  return (
    <div
      style={{
        minHeight: "100vh",
        background: "linear-gradient(180deg, rgba(0,0,0,0.04), rgba(0,0,0,0.02))",
        padding: 20,
        fontFamily:
          "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji",
      }}
    >
      <div style={{ maxWidth: 900, margin: "0 auto" }}>
        <div style={{ display: "flex", alignItems: "flex-start", justifyContent: "space-between", gap: 12 }}>
          <div>
            <div style={{ fontSize: 22, fontWeight: 800 }}>MVP —Ç—Ä–µ–Ω–∞–∂—ë—Ä –º—ã—à–ª–µ–Ω–∏—è</div>
            <div style={{ marginTop: 6, color: "rgba(0,0,0,0.6)", fontSize: 13 }}>{progressLabel}</div>
          </div>
          <button
            onClick={resetAll}
            style={{
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(0,0,0,0.15)",
              background: "white",
              cursor: "pointer",
              fontWeight: 800,
            }}
          >
            –°–±—Ä–æ—Å
          </button>
        </div>

        {stage === "start" && (
          <div style={{ marginTop: 14 }}>
            <Box>
              <div style={{ fontSize: 18, fontWeight: 800 }}>–°—Ç–∞—Ä—Ç</div>
              <div style={{ marginTop: 10, color: "rgba(0,0,0,0.75)", lineHeight: 1.5 }}>
                –≠—Ç–æ <b>–Ω–µ —É—Ä–æ–∫–∏</b> –∏ <b>–Ω–µ —Ç–µ–º—ã</b>. –¢—ã –ø—Ä–æ—Ö–æ–¥–∏—à—å —Ü–µ–ø–æ—á–∫—É —Å–∏—Ç—É–∞—Ü–∏–π, –≥–¥–µ –Ω—É–∂–Ω–æ –æ–±—ä—è—Å–Ω—è—Ç—å —Ö–æ–¥ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π.
                <br />
                –ö–æ—É—á <b>–Ω–µ –≤—ã–¥–∞—ë—Ç –æ—Ç–≤–µ—Ç</b>, –∞ –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å—ã –∏ —Å—Ç–∞–≤–∏—Ç —Å—Ç–æ–ø, –µ—Å–ª–∏ –æ—Ç–≤–µ—á–∞–µ—à—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–æ.
              </div>
              <div style={{ marginTop: 12, display: "flex", gap: 8, flexWrap: "wrap" }}>
                <Pill>‚úÖ –ù—É–∂–Ω—ã: –∫—Ä–∏—Ç–µ—Ä–∏–∏, –ø—Ä–æ–≤–µ—Ä–∫–∏, –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ</Pill>
                <Pill>üö´ –ù–µ–ª—å–∑—è: ¬´–¥–∞/–Ω–µ—Ç¬ª, ¬´–æ—á–µ–≤–∏–¥–Ω–æ¬ª, ¬´–ø—Ä–æ—Å—Ç–æ¬ª</Pill>
              </div>
              <button
                onClick={start}
                style={{
                  marginTop: 14,
                  width: "100%",
                  padding: "12px 14px",
                  borderRadius: 14,
                  border: "1px solid rgba(0,0,0,0.15)",
                  background: "black",
                  color: "white",
                  fontWeight: 900,
                  cursor: "pointer",
                }}
              >
                –ù–∞—á–∞—Ç—å
              </button>
            </Box>
          </div>
        )}

        {stage === "task" && (
          <div style={{ marginTop: 14 }}>
            <Box>
              <div style={{ display: "flex", justifyContent: "space-between", gap: 10, flexWrap: "wrap" }}>
                <div>
                  <div style={{ fontSize: 18, fontWeight: 900 }}>{task.title}</div>
                  <div style={{ marginTop: 6, color: "rgba(0,0,0,0.65)", fontSize: 13 }}>
                    –¢—Ä–µ–Ω–∏—Ä—É–µ–º: <b>{task.skill}</b>
                  </div>
                </div>
                <Pill>–ú–∞—Ä—à—Ä—É—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω</Pill>
              </div>

              <div
                style={{
                  marginTop: 12,
                  background: "rgba(0,0,0,0.04)",
                  border: "1px solid rgba(0,0,0,0.10)",
                  borderRadius: 14,
                  padding: 12,
                  whiteSpace: "pre-wrap",
                  lineHeight: 1.5,
                }}
              >
                {task.prompt}
              </div>

              <div style={{ marginTop: 14, display: "grid", gridTemplateColumns: "1fr", gap: 12 }}>
                <div>
                  <div style={{ fontWeight: 900, marginBottom: 6 }}>–î–∏–∞–ª–æ–≥</div>
                  <div
                    style={{
                      border: "1px solid rgba(0,0,0,0.12)",
                      borderRadius: 14,
                      padding: 12,
                      maxHeight: 260,
                      overflow: "auto",
                      background: "rgba(255,255,255,0.7)",
                    }}
                  >
                    {messages.length === 0 ? (
                      <div style={{ color: "rgba(0,0,0,0.55)", fontSize: 13 }}>
                        –ù–∞–ø–∏—à–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ –∏ –Ω–∞–∂–º–∏ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª ‚Äî –∫–æ—É—á –∑–∞–¥–∞—Å—Ç —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã.
                      </div>
                    ) : (
                      messages.map((m, idx) => (
                        <div key={idx} style={{ marginBottom: 10 }}>
                          <div style={{ fontWeight: 900, fontSize: 12, color: m.role === "coach" ? "#111" : "#555" }}>
                            {m.role === "coach" ? "–ö–æ—É—á" : "–¢—ã"}
                          </div>
                          <div style={{ whiteSpace: "pre-wrap", lineHeight: 1.45 }}>{m.text}</div>
                        </div>
                      ))
                    )}
                  </div>
                </div>

                <div>
                  <div style={{ fontSize: 12, color: "rgba(0,0,0,0.6)", marginBottom: 6 }}>
                    –ü–∏—à–∏ 2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ ‚Üí –æ—Å–Ω–æ–≤–∞–Ω–∏–µ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞/—É—Å–ª–æ–≤–∏–µ –æ–ø—Ä–æ–≤–µ—Ä–∂–µ–Ω–∏—è.
                  </div>
                  <textarea
                    value={draft}
                    onChange={(e) => setDraft(e.target.value)}
                    placeholder="–û–ø–∏—à–∏, –∫–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å‚Ä¶"
                    style={{
                      width: "100%",
                      minHeight: 110,
                      borderRadius: 14,
                      padding: 12,
                      border: "1px solid rgba(0,0,0,0.15)",
                      outline: "none",
                      resize: "vertical",
                    }}
                  />

                  <div style={{ marginTop: 10, display: "flex", gap: 10, flexWrap: "wrap" }}>
                    <button
                      onClick={submitMessage}
                      disabled={!normalize(draft)}
                      style={{
                        padding: "10px 12px",
                        borderRadius: 12,
                        border: "1px solid rgba(0,0,0,0.15)",
                        background: !normalize(draft) ? "rgba(0,0,0,0.06)" : "white",
                        cursor: !normalize(draft) ? "not-allowed" : "pointer",
                        fontWeight: 900,
                      }}
                    >
                      –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>

                    <button
                      onClick={goToReflection}
                      disabled={lock || messages.length < 2}
                      title={lock ? "–ö–æ—É—á –ø–æ—Å—Ç–∞–≤–∏–ª —Å—Ç–æ–ø ‚Äî –¥–æ–ø–æ–ª–Ω–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ" : "–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏"}
                      style={{
                        padding: "10px 12px",
                        borderRadius: 12,
                        border: "1px solid rgba(0,0,0,0.15)",
                        background: lock || messages.length < 2 ? "rgba(0,0,0,0.06)" : "black",
                        color: lock || messages.length < 2 ? "rgba(0,0,0,0.6)" : "white",
                        cursor: lock || messages.length < 2 ? "not-allowed" : "pointer",
                        fontWeight: 900,
                      }}
                    >
                      –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
                    </button>

                    {lock && <Pill>‚õî –°—Ç–æ–ø: –æ—Ç–≤–µ—Ç –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–π ‚Äî –¥–æ–ø–æ–ª–Ω–∏</Pill>}
                  </div>
                </div>
              </div>
            </Box>
          </div>
        )}

        {stage === "reflect" && (
          <div style={{ marginTop: 14 }}>
            <Box>
              <div style={{ fontSize: 18, fontWeight: 900 }}>–†–µ—Ñ–ª–µ–∫—Å–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
              <div style={{ marginTop: 8, color: "rgba(0,0,0,0.65)" }}>
                –ë–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤—Å–µ 3 –≤–æ–ø—Ä–æ—Å–∞ –∑–∞–¥–∞—á–∞ –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–π.
              </div>

              <div style={{ marginTop: 12, display: "grid", gap: 10 }}>
                <div>
                  <div style={{ fontWeight: 900, marginBottom: 6 }}>1) –ì–¥–µ —Ç—ã —Å–Ω–∞—á–∞–ª–∞ –æ—à–∏–±—Å—è –∏–ª–∏ –∑–∞—Å—Ç—Ä—è–ª?</div>
                  <textarea
                    value={reflection.q1}
                    onChange={(e) => setReflection((r) => ({ ...r, q1: e.target.value }))}
                    style={{ width: "100%", minHeight: 70, borderRadius: 14, padding: 12, border: "1px solid rgba(0,0,0,0.15)" }}
                  />
                </div>
                <div>
                  <div style={{ fontWeight: 900, marginBottom: 6 }}>2) –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ —Ç–≤–æ—ë–º —Å–ø–æ—Å–æ–±–µ –º—ã—à–ª–µ–Ω–∏—è?</div>
                  <textarea
                    value={reflection.q2}
                    onChange={(e) => setReflection((r) => ({ ...r, q2: e.target.value }))}
                    style={{ width: "100%", minHeight: 70, borderRadius: 14, padding: 12, border: "1px solid rgba(0,0,0,0.15)" }}
                  />
                </div>
                <div>
                  <div style={{ fontWeight: 900, marginBottom: 6 }}>3) –ß—Ç–æ –±—ã —Ç—ã —Å–¥–µ–ª–∞–ª –∏–Ω–∞—á–µ, –Ω–∞—á–∏–Ω–∞—è —Å–Ω–∞—á–∞–ª–∞?</div>
                  <textarea
                    value={reflection.q3}
                    onChange={(e) => setReflection((r) => ({ ...r, q3: e.target.value }))}
                    style={{ width: "100%", minHeight: 70, borderRadius: 14, padding: 12, border: "1px solid rgba(0,0,0,0.15)" }}
                  />
                </div>
              </div>

              <div style={{ marginTop: 12, display: "flex", gap: 10, flexWrap: "wrap" }}>
                <button
                  onClick={() => setStage("task")}
                  style={{ padding: "10px 12px", borderRadius: 12, border: "1px solid rgba(0,0,0,0.15)", background: "white", cursor: "pointer", fontWeight: 900 }}
                >
                  –ù–∞–∑–∞–¥ –∫ –∑–∞–¥–∞—á–µ
                </button>

                <button
                  onClick={submitReflection}
                  disabled={!reflectionValid(reflection)}
                  style={{
                    padding: "10px 12px",
                    borderRadius: 12,
                    border: "1px solid rgba(0,0,0,0.15)",
                    background: reflectionValid(reflection) ? "black" : "rgba(0,0,0,0.06)",
                    color: reflectionValid(reflection) ? "white" : "rgba(0,0,0,0.6)",
                    cursor: reflectionValid(reflection) ? "pointer" : "not-allowed",
                    fontWeight: 900,
                  }}
                >
                  –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –¥–∞–ª—å—à–µ
                </button>

                {!reflectionValid(reflection) && <Pill>–ó–∞–ø–æ–ª–Ω–∏ 3 –ø–æ–ª—è (–Ω–µ –º–µ–Ω–µ–µ 6 —Å–ª–æ–≤)</Pill>}
              </div>
            </Box>
          </div>
        )}

        {stage === "done" && (
          <div style={{ marginTop: 14 }}>
            <Box>
              <div style={{ fontSize: 18, fontWeight: 900 }}>–ì–æ—Ç–æ–≤–æ</div>
              <div style={{ marginTop: 10, color: "rgba(0,0,0,0.75)", lineHeight: 1.5 }}>
                –¢—ã –ø—Ä–æ—à—ë–ª –≤—Å–µ –∑–∞–¥–∞—á–∏ —Ü–∏–∫–ª–∞. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å <b>–Ω–æ–≤—ã–π —Ü–∏–∫–ª</b> ‚Äî –∑–∞–¥–∞–Ω–∏—è –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∑–∞–Ω–æ–≤–æ
                (–Ω–æ–≤—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏ –¥—Ä—É–≥–æ–π –ø–æ—Ä—è–¥–æ–∫), –Ω–æ –±—É–¥—É—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–µ –∂–µ –Ω–∞–≤—ã–∫–∏.
              </div>

              <div style={{ marginTop: 12, display: "flex", gap: 10, flexWrap: "wrap" }}>
                <button
                  onClick={() => {
                    const nextSeed = seed + 1;
                    setSeed(nextSeed);
                    setCycle((c) => c + 1);
                    setTasks(generateTasks(nextSeed));
                    setTaskIndex(0);
                    setMessages([
                      {
                        role: "coach",
                        text: "–ù–æ–≤—ã–π —Ü–∏–∫–ª. –°–Ω–∞—á–∞–ª–∞ ‚Äî —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ (2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è). –ë–µ–∑ ¬´–¥–∞/–Ω–µ—Ç¬ª.",
                      },
                    ]);
                    setDraft("");
                    setLock(false);
                    setReflection({ q1: "", q2: "", q3: "" });
                    setStage("task");
                  }}
                  style={{
                    flex: "1 1 260px",
                    padding: "12px 14px",
                    borderRadius: 14,
                    border: "1px solid rgba(0,0,0,0.15)",
                    background: "black",
                    color: "white",
                    fontWeight: 900,
                    cursor: "pointer",
                  }}
                >
                  –ù–æ–≤—ã–π —Ü–∏–∫–ª (–Ω–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è)
                </button>

                <button
                  onClick={resetAll}
                  style={{
                    flex: "1 1 160px",
                    padding: "12px 14px",
                    borderRadius: 14,
                    border: "1px solid rgba(0,0,0,0.15)",
                    background: "white",
                    color: "#111",
                    fontWeight: 900,
                    cursor: "pointer",
                  }}
                >
                  –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
                </button>
              </div>
            </Box>
          </div>
        )}
      </div>
    </div>
  );
}
